# Claude Menu - AI-Powered Restaurant Menu Designer

## Overview
Claude Menu is a SaaS application that transforms restaurant menus into stunning, professional designs using AI. Users upload their menu in PDF or Word format, customize colors and style preferences, and receive 3 unique HTML menu designs generated by Claude AI.

## Current State
**Status**: MVP Complete and Functional

The application is fully implemented with:
- User authentication via Replit Auth (supports Google, GitHub, email/password)
- Stripe subscription management ($29/month Pro plan)
- File upload and text extraction (PDF and DOCX)
- AI-powered menu generation using Claude 3.5 Sonnet
- 3 unique HTML design variations per generation
- Design selection and HTML download functionality
- Full user dashboard with generation history

## Recent Changes (November 23, 2024)
- ‚úÖ Implemented complete frontend with landing page, dashboard, generator, results, and subscription pages
- ‚úÖ Built backend API with Replit Auth, Stripe integration, and Claude AI
- ‚úÖ Set up PostgreSQL database with Drizzle ORM
- ‚úÖ Fixed routing using Redirect components to properly separate authenticated/unauthenticated routes
- ‚úÖ Fixed session cookies to work in development (sameSite='lax', secure=true)
- ‚úÖ Added Stripe webhook handling with rawBody support for subscription status updates
- ‚úÖ Implemented file upload with PDF/DOCX text extraction
- ‚úÖ Changed AI generation to synchronous flow for immediate design availability
- ‚úÖ Created AI generation pipeline for 3 menu design variations
- ‚úÖ Implemented centralized subscription checking with `ensureActiveSubscription()` helper
- ‚úÖ Added development subscription bypass with production security guard
- ‚úÖ Fixed subscription status persistence to be immediate in development mode
- ‚úÖ Added startup validation to prevent bypass in non-development environments
- ‚úÖ **Made menu generation FREE for everyone**
- ‚úÖ **Moved subscription requirement to downloads only**
- ‚úÖ **Added SUBSCRIPTION_REQUIRED flag for fully optional subscription system**
- ‚úÖ **Subscription can now be completely disabled for free deployments**

## Project Architecture

### Frontend (`client/`)
- **Framework**: React with Wouter for routing
- **UI Library**: Shadcn/UI components with Tailwind CSS
- **State Management**: TanStack Query for server state
- **Pages**:
  - `/` - Landing page (public) or Dashboard (authenticated)
  - `/generate` - Menu generator with file upload and customization
  - `/result/:id` - View and download generated designs
  - `/subscribe` - Stripe subscription checkout

### Backend (`server/`)
- **Framework**: Express.js
- **Database**: PostgreSQL with Drizzle ORM
- **Authentication**: Replit Auth (OpenID Connect)
- **Payment**: Stripe subscriptions
- **AI**: Anthropic Claude 3.5 Sonnet
- **File Processing**: pdf-parse and mammoth for text extraction

### Database Schema
- `users` - User accounts with Stripe customer/subscription info
- `menuGenerations` - Menu generation records with extracted text and AI-generated designs
- `sessions` - Session storage for authentication

## API Routes
- `GET /api/auth/user` - Get authenticated user
- `POST /api/login` - Initiate login flow
- `POST /api/logout` - Logout user
- `GET /api/subscription/status` - Check subscription status
- `POST /api/create-subscription` - Create Stripe subscription
- `POST /api/webhook/stripe` - Handle Stripe webhooks
- `POST /api/upload` - Upload and extract text from menu file
- `POST /api/generate` - Generate 3 AI menu designs
- `GET /api/generations` - Get user's generations
- `GET /api/generations/:id` - Get specific generation
- `POST /api/generations/:id/select` - Select a design variation
- `GET /api/generations/:id/download/:variation` - Download HTML

## User Preferences
- Design System: Vercel-style minimalist aesthetic with clean typography
- Color Scheme: Primary blue (#3b82f6), with automatic dark mode support
- Typography: Inter font family throughout

## Development
- **Start Dev Server**: Workflow "Start application" runs `npm run dev`
- **Database Migrations**: `npm run db:push`
- **Type Checking**: `npm run check`

## Environment Variables
Required secrets (already configured):
- `DATABASE_URL` - PostgreSQL connection string
- `SESSION_SECRET` - Session encryption key
- `ANTHROPIC_API_KEY` - Claude AI API key
- `STRIPE_SECRET_KEY` - Stripe secret key
- `VITE_STRIPE_PUBLIC_KEY` - Stripe publishable key

Optional (recommended for production):
- `STRIPE_WEBHOOK_SECRET` - Required for Stripe webhook signature verification in production
- `STRIPE_PRICE_ID` - Reusable Stripe price ID (otherwise created on-the-fly)

Development environment variables (configured for testing):
- `ENABLE_DEV_SUBSCRIPTION_BYPASS` - Set to "true" in development to enable subscription bypass
- `SUBSCRIPTION_REQUIRED` - Set to "false" to disable subscription features entirely (default: "true")

**Subscription Modes:**

1. **Subscription Required (default)**: `SUBSCRIPTION_REQUIRED=true` or not set
   - Users can generate menus for FREE
   - Subscription required only for DOWNLOADING designs
   - With `ENABLE_DEV_SUBSCRIPTION_BYPASS=true` and no `STRIPE_WEBHOOK_SECRET`, subscription creation immediately sets `subscriptionStatus='active'` for testing
   - In production, set `STRIPE_WEBHOOK_SECRET` for webhook signature verification

2. **Subscription Optional**: `SUBSCRIPTION_REQUIRED=false`
   - Everything is FREE - no Stripe integration needed
   - All subscription UI is hidden
   - Users can generate AND download without any payment
   - Perfect for free/open-source deployments

**Development Bypass (when SUBSCRIPTION_REQUIRED=true):**
- Requires: ENABLE_DEV_SUBSCRIPTION_BYPASS=true + NODE_ENV=development + No STRIPE_WEBHOOK_SECRET
- Server crashes at startup if enabled outside development environment
- Logs warning message when active
- Should NEVER be enabled in production

**Production Mode (when SUBSCRIPTION_REQUIRED=true):**
- Set `STRIPE_WEBHOOK_SECRET` to enable webhook signature verification
- Subscriptions start with `status='incomplete'` and update to `'active'` when webhook fires after successful payment

## Key Features
1. **Authentication**: Seamless login with Replit Auth supporting multiple providers
2. **Free Generation**: Users can generate menu designs for FREE
3. **Optional Subscription**: Subscribe only if you want to download designs (configurable)
4. **File Upload**: Drag-and-drop interface for PDF and DOCX files
5. **Text Extraction**: Automatic extraction of menu content
6. **AI Generation**: Claude generates 3 unique professional HTML designs
7. **Customization**: Color palette picker, size selection, style prompts
8. **Download**: Export selected designs as standalone HTML files (subscription-gated if enabled)
9. **Dashboard**: View generation history and subscription status

## Technical Decisions
- **Replit Auth over Google OAuth**: Provides multi-provider support with easier setup
- **PostgreSQL**: Required for session storage and data persistence
- **Stripe Subscriptions**: Recurring billing for SaaS model
- **Claude API**: Generates creative, high-quality HTML designs
- **Standalone HTML**: No dependencies, ready to print or publish
- **Synchronous AI Generation**: Immediate design availability for better UX
- **Centralized Subscription Check**: Single `ensureActiveSubscription()` helper ensures consistent gating across all paywalled endpoints
- **Development Bypass**: Enables testing without webhook configuration, with strict production safeguards

## MVP Complete - Next Phase Features

**Current MVP Features (Complete):**
- ‚úÖ User authentication with Replit Auth
- ‚úÖ Stripe subscription checkout and management
- ‚úÖ PDF/DOCX file upload and text extraction
- ‚úÖ AI-powered menu generation (3 variations)
- ‚úÖ Design preview and HTML download
- ‚úÖ Generation history dashboard
- ‚úÖ Development testing bypass with security guards

**Next Phase Features (Not Yet Implemented):**
- üìÑ PDF export using Puppeteer - Convert HTML designs to printable PDFs
- üí≥ Stripe customer portal - Self-service subscription management and cancellation
- üé® Design templates and presets - Pre-configured styles for common menu types
- ‚úèÔ∏è Design editing capability - Modify AI-generated menus before download
- üë• Team collaboration features - Share and collaborate on menu designs

## Security & Production Readiness

**Development Testing:**
- Set `ENABLE_DEV_SUBSCRIPTION_BYPASS=true` to bypass webhook requirement
- Server validates environment at startup and crashes if misconfigured
- All protected routes use centralized `ensureActiveSubscription()` helper

**Production Deployment:**
- Must set `STRIPE_WEBHOOK_SECRET` for webhook signature verification
- Must NOT set `ENABLE_DEV_SUBSCRIPTION_BYPASS` (server will crash if enabled)
- Webhook updates subscription status to 'active' after payment
- All routes consistently enforce subscription status
